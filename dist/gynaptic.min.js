function Neuron(){this.ID=Neuron.uid(),this.label=null,this.connections={inputs:{},projected:{},gated:{}},this.error={responsibility:0,projected:0,gated:0},this.trace={elegibility:{},extended:{},influences:{}},this.state=0,this.old=0,this.activation=0,this.selfconnection=new Neuron.connection(this,this,0),this.squash=Neuron.squash.LOGISTIC,this.neighboors={},this.bias=.2*Math.random()-.1}function Layer(a,b){for(this.size=0|a,this.list=[],this.label=b||null,this.connectedTo=[];a--;){var c=new Neuron;this.list.push(c)}}function Network(a){"undefined"!=typeof a&&(this.layers=a||{input:null,hidden:{},output:null},this.optimized=null)}function Trainer(a,b){b=b||{},this.network=a,this.rate=b.rate||.2,this.iterations=b.iterations||1e5,this.error=b.error||.005,this.cost=b.cost||null,this.crossValidate=b.crossValidate||null}function Evolution(a){a=a||{},this.size=a.size||50,this.mutationRate=a.mutationRate||.05,this.mutationMethod=a.mutationMethod||[Mutate.MODIFY_RANDOM_WEIGHT],this.crossOverMethod=a.crossOverMethod||[Crossover.UNIFORM],this.selectionMethod=a.selectionMethod||[Selection.FITNESS_PROPORTIONATE],this.fitnessFunction=a.fitnessFunction,this.networkSize=a.networkSize||[1,4,1],this.elitism=a.elitism||Math.round(this.size/20),this.population=[],this.createPool(),this.newPopulation=[],this.parentSelection=[],this.scores=[]}Neuron.prototype={activate:function(a){if("undefined"!=typeof a)return this.activation=a,this.derivative=0,this.bias=0,this.activation;this.old=this.state,this.state=this.selfconnection.gain*this.selfconnection.weight*this.state+this.bias;for(var b in this.connections.inputs){var a=this.connections.inputs[b];this.state+=a.from.activation*a.weight*a.gain}this.activation=this.squash(this.state),this.derivative=this.squash(this.state,!0);var c=[];for(var d in this.trace.extended){var e=this.neighboors[d],f=e.selfconnection.gater==this?e.old:0;for(var g in this.trace.influences[e.ID])f+=this.trace.influences[e.ID][g].weight*this.trace.influences[e.ID][g].from.activation;c[e.ID]=f}for(var b in this.connections.inputs){var a=this.connections.inputs[b];this.trace.elegibility[a.ID]=this.selfconnection.gain*this.selfconnection.weight*this.trace.elegibility[a.ID]+a.gain*a.from.activation;for(var d in this.trace.extended){var h=this.trace.extended[d],e=this.neighboors[d],f=c[e.ID];h[a.ID]=e.selfconnection.gain*e.selfconnection.weight*h[a.ID]+this.derivative*this.trace.elegibility[a.ID]*f}}for(var i in this.connections.gated)this.connections.gated[i].gain=this.activation;return this.activation},propagate:function(a,b){var c=0,d="undefined"!=typeof b;if(d)this.error.responsibility=this.error.projected=b-this.activation;else{for(var e in this.connections.projected){var f=this.connections.projected[e],g=f.to;c+=g.error.responsibility*f.gain*f.weight}this.error.projected=this.derivative*c,c=0;for(var e in this.trace.extended){var g=this.neighboors[e],h=g.selfconnection.gater==this?g.old:0;for(var i in this.trace.influences[e])h+=this.trace.influences[e][i].weight*this.trace.influences[g.ID][i].from.activation;c+=g.error.responsibility*h}this.error.gated=this.derivative*c,this.error.responsibility=this.error.projected+this.error.gated}a=a||.1;for(var e in this.connections.inputs){var i=this.connections.inputs[e],j=this.error.projected*this.trace.elegibility[i.ID];for(var e in this.trace.extended){var g=this.neighboors[e];j+=g.error.responsibility*this.trace.extended[g.ID][i.ID]}i.weight+=a*j}this.bias+=a*this.error.responsibility},project:function(a,b){if(a==this)return this.selfconnection.weight=1,this.selfconnection;var c=this.connected(a);if(c&&"projected"==c.type)return"undefined"!=typeof b&&(c.connection.weight=b),c.connection;var d=new Neuron.connection(this,a,b);this.connections.projected[d.ID]=d,this.neighboors[a.ID]=a,a.connections.inputs[d.ID]=d,a.trace.elegibility[d.ID]=0;for(var e in a.trace.extended){var f=a.trace.extended[e];f[d.ID]=0}return d},gate:function(a){this.connections.gated[a.ID]=a;var b=a.to;if(!(b.ID in this.trace.extended)){this.neighboors[b.ID]=b;var c=this.trace.extended[b.ID]={};for(var d in this.connections.inputs){var e=this.connections.inputs[d];c[e.ID]=0}}b.ID in this.trace.influences?this.trace.influences[b.ID].push(a):this.trace.influences[b.ID]=[a],a.gater=this},selfconnected:function(){return 0!==this.selfconnection.weight},connected:function(a){var b={type:null,connection:!1};if(this==a)return!!this.selfconnected()&&(b.type="selfconnection",b.connection=this.selfconnection,b);for(var c in this.connections)for(var d in this.connections[c]){var d=this.connections[c][d];if(d.to==a)return b.type=c,b.connection=d,b;if(d.from==a)return b.type=c,b.connection=d,b}return!1},clear:function(){for(var a in this.trace.elegibility)this.trace.elegibility[a]=0;for(var a in this.trace.extended)for(var b in this.trace.extended[a])this.trace.extended[a][b]=0;this.error.responsibility=this.error.projected=this.error.gated=0},reset:function(){this.clear();for(var a in this.connections)for(var b in this.connections[a])this.connections[a][b].weight=.2*Math.random()-.1;this.bias=.2*Math.random()-.1,this.old=this.state=this.activation=0},mutate:function(a){switch(a=a||Mutate.MODIFY_RANDOM_WEIGHT){case Mutate.SWAP_WEIGHT:for(var b=["gated","inputs","projected"],c=["gated","inputs","projected"],d=2;d>=0;d--)0==Object.keys(this.connections[b[d]]).length&&b.splice(d,1),0==Object.keys(this.connections[c[d]]).length&&c.splice(d,1);b=b[Math.floor(Math.random()*b.length)];var e=Object.keys(this.connections[b]),f=e[Math.floor(Math.random()*e.length)];c=c[Math.floor(Math.random()*c.length)];var g=Object.keys(this.connections[c]),h=g[Math.floor(Math.random()*g.length)],i=this.connections[b][f].weight;this.connections[b][f].weight=this.connections[c][h].weight,this.connections[c][h].weight=i;break;case Mutate.MODIFY_RANDOM_BIAS:this.bias+=2*(Math.random()-.5);break;case Mutate.MODIFY_RANDOM_WEIGHT:for(var j=["gated","inputs","projected"],d=2;d>=0;d--)0==Object.keys(this.connections[j[d]]).length&&j.splice(d,1);j=j[Math.floor(Math.random()*j.length)];var k=Object.keys(this.connections[j]),l=k[Math.floor(Math.random()*k.length)];this.connections[j][l].weight+=2*(Math.random()-.5)}},optimize:function(a,b){a=a||{};var c=[],d=[],e=[],f=a.memory||0,g=a.neurons||1,h=a.inputs||[],i=a.targets||[],j=a.outputs||[],k=a.variables||{},l=a.activation_sentences||[],m=a.trace_sentences||[],n=a.propagation_sentences||[],o=a.layers||{__count:0,__neuron:0},p=function(a){var c=b in o&&a[o.__count];c||(o.__count=a.push([])-1,o[b]=o.__count)};p(l),p(m),p(n);var q=o.__count,r=function(){var a=Array.prototype.slice.call(arguments);if(1==a.length){if("target"==a[0]){var b="target_"+i.length;i.push(f)}else var b=a[0];return b in k?k[b]:k[b]={value:0,id:f++}}var c=a.length>2;if(c)var d=a.pop();var e=a.shift(),g=a.pop();if(!c)var d=e[g];var b=g+"_";for(var h in a)b+=a[h]+"_";return b+=e.ID,b in k?k[b]:k[b]={value:d,id:f++}},s=function(){var a=Array.prototype.slice.call(arguments),b=a.pop(),c="";for(var d in a)c+="string"==typeof a[d]?a[d]:"F["+a[d].id+"]";b.push(c+";")},t=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},u=t(this.connections.projected),v=t(this.connections.gated),w="input"==b||t(this.connections.inputs),x="output"==b||u&&v,y=r("rate"),z=r(this,"activation");if(w)h.push(z.id);else{l[q].push(c),m[q].push(d),n[q].push(e);var A=r(this,"old"),B=r(this,"state"),C=r(this,"bias");if(this.selfconnection.gater)var D=r(this.selfconnection,"gain");if(this.selfconnected())var E=r(this.selfconnection,"weight");s(A," = ",B,c),this.selfconnected()?this.selfconnection.gater?s(B," = ",D," * ",E," * ",B," + ",C,c):s(B," = ",E," * ",B," + ",C,c):s(B," = ",C,c);for(var F in this.connections.inputs){var G=this.connections.inputs[F],H=r(G.from,"activation"),I=r(G,"weight");if(G.gater)var J=r(G,"gain");this.connections.inputs[F].gater?s(B," += ",H," * ",I," * ",J,c):s(B," += ",H," * ",I,c)}var K=r(this,"derivative");switch(this.squash){case Neuron.squash.LOGISTIC:s(z," = (1 / (1 + Math.exp(-",B,")))",c),s(K," = ",z," * (1 - ",z,")",c);break;case Neuron.squash.TANH:var L=r("aux"),M=r("aux_2");s(L," = Math.exp(",B,")",c),s(M," = 1 / ",L,c),s(z," = (",L," - ",M,") / (",L," + ",M,")",c),s(K," = 1 - (",z," * ",z,")",c);break;case Neuron.squash.IDENTITY:s(z," = ",B,c),s(K," = 1",c);break;case Neuron.squash.HLIM:s(z," = +(",B," > 0)",c),s(K," = 1",c);case Neuron.squash.RELU:s(z," = ",B," > 0 ? ",B," : 0",c),s(K," = ",B," > 0 ? 1 : 0",c)}for(var N in this.trace.extended){var O=this.neighboors[N],P=r("influences["+O.ID+"]"),Q=r(O,"old"),R=!1;O.selfconnection.gater==this&&(s(P," = ",Q,d),R=!0);for(var S in this.trace.influences[O.ID]){var T=r(this.trace.influences[O.ID][S],"weight"),U=r(this.trace.influences[O.ID][S].from,"activation");R?s(P," += ",T," * ",U,d):(s(P," = ",T," * ",U,d),R=!0)}}for(var F in this.connections.inputs){var G=this.connections.inputs[F];if(G.gater)var J=r(G,"gain");var H=r(G.from,"activation"),V=r(this,"trace","elegibility",G.ID,this.trace.elegibility[G.ID]);this.selfconnected()?this.selfconnection.gater?G.gater?s(V," = ",D," * ",E," * ",V," + ",J," * ",H,d):s(V," = ",D," * ",E," * ",V," + ",H,d):G.gater?s(V," = ",E," * ",V," + ",J," * ",H,d):s(V," = ",E," * ",V," + ",H,d):G.gater?s(V," = ",J," * ",H,d):s(V," = ",H,d);for(var N in this.trace.extended){var O=this.neighboors[N],P=r("influences["+O.ID+"]"),V=r(this,"trace","elegibility",G.ID,this.trace.elegibility[G.ID]),W=r(this,"trace","extended",O.ID,G.ID,this.trace.extended[O.ID][G.ID]);if(O.selfconnected())var X=r(O.selfconnection,"weight");if(O.selfconnection.gater)var Y=r(O.selfconnection,"gain");O.selfconnected()?O.selfconnection.gater?s(W," = ",Y," * ",X," * ",W," + ",K," * ",V," * ",P,d):s(W," = ",X," * ",W," + ",K," * ",V," * ",P,d):s(W," = ",K," * ",V," * ",P,d)}}for(var Z in this.connections.gated){var $=r(this.connections.gated[Z],"gain");s($," = ",z,c)}}if(!w){var _=r(this,"error","responsibility",this.error.responsibility);if(x){var aa=r("target");s(_," = ",aa," - ",z,e);for(var N in this.connections.inputs){var G=this.connections.inputs[N],V=r(this,"trace","elegibility",G.ID,this.trace.elegibility[G.ID]),I=r(G,"weight");s(I," += ",y," * (",_," * ",V,")",e)}j.push(z.id)}else if(u||v){if(v){s(_," = 0",e);for(var N in this.connections.projected){var Z=this.connections.projected[N],O=Z.to,ca=r(Z,"weight"),da=r(O,"error","responsibility",O.error.responsibility);if(Z.gater){var ea=r(Z,"gain");s(_," += ",da," * ",ea," * ",ca,e)}else s(_," += ",da," * ",ca,e)}s(_," *= ",K,e);for(var N in this.connections.inputs){var G=this.connections.inputs[N],V=r(this,"trace","elegibility",G.ID,this.trace.elegibility[G.ID]),I=r(G,"weight");s(I," += ",y," * (",_," * ",V,")",e)}}else if(u){s(_," = 0",e);for(var N in this.trace.extended){var O=this.neighboors[N],P=r("aux"),Q=r(O,"old");O.selfconnection.gater==this?s(P," = ",Q,e):s(P," = 0",e);for(var G in this.trace.influences[O.ID]){var Z=this.trace.influences[O.ID][G],ca=r(Z,"weight"),ga=r(Z.from,"activation");s(P," += ",ca," * ",ga,e)}var da=r(O,"error","responsibility",O.error.responsibility);s(_," += ",da," * ",P,e)}s(_," *= ",K,e);for(var N in this.connections.inputs){var G=this.connections.inputs[N],ia=r("aux");s(ia," = 0",e);for(var N in this.trace.extended){var O=this.neighboors[N],da=r(O,"error","responsibility",O.error.responsibility),W=r(this,"trace","extended",O.ID,G.ID,this.trace.extended[O.ID][G.ID]);s(ia," += ",da," * ",W,e)}var I=r(G,"weight");s(I," += ",y," * ",ia,e)}}}else{var ba=r("aux");for(var N in this.connections.projected){var Z=this.connections.projected[N],O=Z.to,ca=r(Z,"weight"),da=r(O,"error","responsibility",O.error.responsibility);if(Z.gater){var ea=r(Z,"gain");s(ba," += ",da," * ",ea," * ",ca,e)}else s(ba," += ",da," * ",ca,e)}var fa=r(this,"error","projected",this.error.projected);s(fa," = ",K," * ",ba,e),s(ba," = 0",e);for(var N in this.trace.extended){var O=this.neighboors[N],P=r("aux_2"),Q=r(O,"old");O.selfconnection.gater==this?s(P," = ",Q,e):s(P," = 0",e);for(var G in this.trace.influences[O.ID]){var Z=this.trace.influences[O.ID][G],ca=r(Z,"weight"),ga=r(Z.from,"activation");s(P," += ",ca," * ",ga,e)}var da=r(O,"error","responsibility",O.error.responsibility);s(ba," += ",da," * ",P,e)}var ha=r(this,"error","gated",this.error.gated);s(ha," = ",K," * ",ba,e),s(_," = ",fa," + ",ha,e);for(var N in this.connections.inputs){var G=this.connections.inputs[N],ia=r("aux"),V=r(this,"trace","elegibility",G.ID,this.trace.elegibility[G.ID]);s(ia," = ",fa," * ",V,e);for(var N in this.trace.extended){var O=this.neighboors[N],da=r(O,"error","responsibility",O.error.responsibility),W=r(this,"trace","extended",O.ID,G.ID,this.trace.extended[O.ID][G.ID]);s(ia," += ",da," * ",W,e)}var I=r(G,"weight");s(I," += ",y," * ",ia,e)}}s(C," += ",y," * ",_,e)}return{memory:f,neurons:g+1,inputs:h,outputs:j,targets:i,variables:k,activation_sentences:l,trace_sentences:m,propagation_sentences:n,layers:o}}},Neuron.connection=function(b,c,d){if(!b||!c)throw new Error("Connection Error: Invalid neurons");this.ID=Neuron.connection.uid(),this.from=b,this.to=c,this.weight="undefined"==typeof d?.2*Math.random()-.1:d,this.gain=1,this.gater=null},Neuron.crossOver=function(a,b,c){c=c||Crossover.UNIFORM;var d=new Neuron;switch(c){case Crossover.UNIFORM:Math.random()>=.5?d.bias=a.bias:d.bias=b.bias;break;case Crossover.AVERAGE:d.bias=(a.bias+b.bias)/2}return d},Neuron.squash={},Neuron.squash.LOGISTIC=function(a,b){if(!b)return 1/(1+Math.exp(-a));var c=Neuron.squash.LOGISTIC(a);return c*(1-c)},Neuron.squash.TANH=function(a,b){if(b)return 1-Math.pow(Neuron.squash.TANH(a),2);var c=Math.exp(a),d=1/c;return(c-d)/(c+d)},Neuron.squash.IDENTITY=function(a,b){return b?1:a},Neuron.squash.HLIM=function(a,b){return b?1:a>0?1:0},Neuron.squash.RELU=function(a,b){return b?a>0?1:0:a>0?a:0},function(){var a=0,b=0;Neuron.uid=function(){return a++},Neuron.connection.uid=function(){return b++},Neuron.quantity=function(){return{neurons:a,connections:b}}}(),Layer.prototype={activate:function(a){var b=[];if("undefined"!=typeof a){if(a.length!=this.size)throw new Error("INPUT size and LAYER size must be the same to activate!");for(var c in this.list){var d=this.list[c],e=d.activate(a[c]);b.push(e)}}else for(var c in this.list){var d=this.list[c],e=d.activate();b.push(e)}return b},propagate:function(a,b){if("undefined"!=typeof b){if(b.length!=this.size)throw new Error("TARGET size and LAYER size must be the same to propagate!");for(var c=this.list.length-1;c>=0;c--){var d=this.list[c];d.propagate(a,b[c])}}else for(var c=this.list.length-1;c>=0;c--){var d=this.list[c];d.propagate(a)}},project:function(a,b,c){if(a instanceof Network&&(a=a.layers.input),!(a instanceof Layer))throw new Error("Invalid argument, you can only project connections to LAYERS and NETWORKS!");if(!this.connected(a))return new Layer.connection(this,a,b,c)},gate:function(a,b){if(b==Layer.gateType.INPUT){if(a.to.size!=this.size)throw new Error("GATER layer and CONNECTION.TO layer must be the same size in order to gate!");for(var c in a.to.list){var d=a.to.list[c],e=this.list[c];for(var f in d.connections.inputs){var g=d.connections.inputs[f];g.ID in a.connections&&e.gate(g)}}}else if(b==Layer.gateType.OUTPUT){if(a.from.size!=this.size)throw new Error("GATER layer and CONNECTION.FROM layer must be the same size in order to gate!");for(var c in a.from.list){var d=a.from.list[c],e=this.list[c];for(var h in d.connections.projected){var g=d.connections.projected[h];g.ID in a.connections&&e.gate(g)}}}else if(b==Layer.gateType.ONE_TO_ONE){if(a.size!=this.size)throw new Error("The number of GATER UNITS must be the same as the number of CONNECTIONS to gate!");for(var c in a.list){var e=this.list[c],g=a.list[c];e.gate(g)}}a.gatedfrom.push({layer:this,type:b})},selfconnected:function(){for(var a in this.list){var b=this.list[a];if(!b.selfconnected())return!1}return!0},connected:function(a){var b=0;for(var c in this.list)for(var d in a.list){var e=this.list[c],f=a.list[d],g=e.connected(f);"projected"==g.type&&b++}if(b==this.size*a.size)return Layer.connectionType.ALL_TO_ALL;b=0;for(var h in this.list){var e=this.list[h],f=a.list[h],g=e.connected(f);"projected"==g.type&&b++}return b==this.size?Layer.connectionType.ONE_TO_ONE:void 0},clear:function(){for(var a in this.list){var b=this.list[a];b.clear()}},reset:function(){for(var a in this.list){var b=this.list[a];b.reset()}},neurons:function(){return this.list},add:function(a){this.neurons[a.ID]=a||new Neuron,this.list.push(a),this.size++},set:function(a){a=a||{};for(var b in this.list){var c=this.list[b];a.label&&(c.label=a.label+"_"+c.ID),a.squash&&(c.squash=a.squash),a.bias&&(c.bias=a.bias)}return this},mutate:function(a){switch(a=a||Mutate.MODIFY_RANDOM_WEIGHT){case Mutate.SWAP_WEIGHT:for(var b=this.list[Math.floor(Math.random()*this.list.length)],c=this.list[Math.floor(Math.random()*this.list.length)],d=["gated","inputs","projected"],e=["gated","inputs","projected"],f=2;f>=0;f--)0==Object.keys(b.connections[d[f]]).length&&d.splice(f,1),0==Object.keys(c.connections[e[f]]).length&&e.splice(f,1);d=d[Math.floor(Math.random()*d.length)];var g=Object.keys(b.connections[d]),h=g[Math.floor(Math.random()*g.length)];e=e[Math.floor(Math.random()*e.length)];var i=Object.keys(c.connections[e]),j=i[Math.floor(Math.random()*i.length)],k=b.connections[d][h].weight;b.connections[d][h].weight=c.connections[e][j].weight,c.connections[e][j].weight=k;break;case Mutate.SWAP_BIAS:var b=Math.floor(Math.random()*this.list.length),c=Math.floor(Math.random()*this.list.length),k=this.list[b].bias;this.list[b].bias=this.list[c].bias,this.list[c].bias=k;break;case Mutate.MODIFY_RANDOM_BIAS:var l=Math.floor(Math.random()*this.list.length);this.list[l].bias+=2*(Math.random()-.5);break;case Mutate.MODIFY_RANDOM_WEIGHT:for(var l=this.list[Math.floor(Math.random()*this.list.length)],m=["gated","inputs","projected"],f=m.length-1;f>=0;f--)0==Object.keys(l.connections[m[f]]).length&&m.splice(f,1);m=m[Math.floor(Math.random()*m.length)];var n=Object.keys(l.connections[m]),o=n[Math.floor(Math.random()*n.length)];l.connections[m][o].weight+=2*(Math.random()-.5)}}},Layer.crossOver=function(a,b,c){c=c||Crossover.UNIFORM;var d=new Layer(a.list.length);switch(c){case Crossover.UNIFORM:for(var e=0;e<d.list.length;e++)Math.round()>=.5?d.list[e].bias=a.list[e].bias:d.list[e].bias=b.list[e].bias;break;case Crossover.AVERAGE:for(var e=0;e<d.list.length;e++){var f=a.list[e].bias,g=b.list[e].bias;d.list[e].bias=(f+g)/2}break;case Crossover.SINGLE_POINT:for(var e=0;e<d.list.length;e++)e/d.list.length<Crossover.SINGLE_POINT[0]?d.list[e].bias=a.list[e].bias:d.list[e].bias=b.list[e].bias;break;case Crossover.TWO_POINT:for(var e=0;e<d.list.length;e++)e/d.list.length<Crossover.SINGLE_POINT[0]||e/d.list.length>Crossover.SINGLE_POINT[1]?d.list[e].bias=a.list[e].bias:d.list[e].bias=b.list[e].bias}return d},Layer.connection=function(b,c,d,e){if(this.ID=Layer.connection.uid(),this.from=b,this.to=c,this.selfconnection=c==b,this.type=d,this.connections={},this.list=[],this.size=0,this.gatedfrom=[],"undefined"==typeof this.type&&(b==c?this.type=Layer.connectionType.ONE_TO_ONE:this.type=Layer.connectionType.ALL_TO_ALL),this.type==Layer.connectionType.ALL_TO_ALL||this.type==Layer.connectionType.ALL_TO_ELSE)for(var f in this.from.list)for(var g in this.to.list){var h=this.from.list[f],i=this.to.list[g];if(this.type!=Layer.connectionType.ALL_TO_ELSE||h!=i){var j=h.project(i,e);this.connections[j.ID]=j,this.size=this.list.push(j)}}else if(this.type==Layer.connectionType.ONE_TO_ONE)for(var k in this.from.list){var h=this.from.list[k],i=this.to.list[k],j=h.project(i,e);this.connections[j.ID]=j,this.size=this.list.push(j)}b.connectedTo.push(this)},Layer.connectionType={},Layer.connectionType.ALL_TO_ALL="ALL TO ALL",Layer.connectionType.ONE_TO_ONE="ONE TO ONE",Layer.connectionType.ALL_TO_ELSE="ALL TO ELSE",Layer.gateType={},Layer.gateType.INPUT="INPUT",Layer.gateType.OUTPUT="OUTPUT",Layer.gateType.ONE_TO_ONE="ONE TO ONE",function(){var a=0;Layer.connection.uid=function(){return a++}}(),Network.prototype={activate:function(a){if(this.optimized===!1){this.layers.input.activate(a);for(var b in this.layers.hidden)this.layers.hidden[b].activate();return this.layers.output.activate()}return null==this.optimized&&this.optimize(),this.optimized.activate(a)},propagate:function(a,b){if(this.optimized===!1){this.layers.output.propagate(a,b);var c=[];for(var d in this.layers.hidden)c.push(this.layers.hidden[d]);c.reverse();for(var d in c)c[d].propagate(a)}else null==this.optimized&&this.optimize(),this.optimized.propagate(a,b)},project:function(a,b,c){if(this.optimized&&this.optimized.reset(),a instanceof Network)return this.layers.output.project(a.layers.input,b,c);if(a instanceof Layer)return this.layers.output.project(a,b,c);throw new Error("Invalid argument, you can only project connections to LAYERS and NETWORKS!")},gate:function(a,b){this.optimized&&this.optimized.reset(),this.layers.output.gate(a,b)},clear:function(){this.restore();var a=this.layers.input,b=this.layers.output;a.clear();for(var c in this.layers.hidden){var d=this.layers.hidden[c];d.clear()}b.clear(),this.optimized&&this.optimized.reset()},reset:function(){this.restore();var a=this.layers.input,b=this.layers.output;a.reset();for(var c in this.layers.hidden){var d=this.layers.hidden[c];d.reset()}b.reset(),this.optimized&&this.optimized.reset()},optimize:function(){var a=this,b={},c=this.neurons();for(var d in c){for(var e=c[d].neuron,f=c[d].layer;e.neuron;)e=e.neuron;b=e.optimize(b,f)}for(var d in b.propagation_sentences)b.propagation_sentences[d].reverse();b.propagation_sentences.reverse();var g="";g+="var F = Float64Array ? new Float64Array("+b.memory+") : []; ";for(var d in b.variables)g+="F["+b.variables[d].id+"] = "+(b.variables[d].value||0)+"; ";g+="var activate = function(input){\n";for(var d in b.inputs)g+="F["+b.inputs[d]+"] = input["+d+"]; ";for(var h in b.activation_sentences)if(b.activation_sentences[h].length>0)for(var i in b.activation_sentences[h])g+=b.activation_sentences[h][i].join(" "),g+=b.trace_sentences[h][i].join(" ");g+=" var output = []; ";for(var d in b.outputs)g+="output["+d+"] = F["+b.outputs[d]+"]; ";g+="return output; }; ",g+="var propagate = function(rate, target){\n",g+="F["+b.variables.rate.id+"] = rate; ";for(var d in b.targets)g+="F["+b.targets[d]+"] = target["+d+"]; ";for(var h in b.propagation_sentences)for(var i in b.propagation_sentences[h])g+=b.propagation_sentences[h][i].join(" ")+" ";g+=" };\n",g+="var ownership = function(memoryBuffer){\nF = memoryBuffer;\nthis.memory = F;\n};\n",g+="return {\nmemory: F,\nactivate: activate,\npropagate: propagate,\nownership: ownership\n};",g=g.split(";").join(";\n");var j=new Function(g),k=j();k.data={variables:b.variables,activate:b.activation_sentences,propagate:b.propagation_sentences,trace:b.trace_sentences,inputs:b.inputs,outputs:b.outputs,check_activation:this.activate,check_propagation:this.propagate},k.reset=function(){a.optimized&&(a.optimized=null,a.activate=k.data.check_activation,a.propagate=k.data.check_propagation)},this.optimized=k,this.activate=k.activate,this.propagate=k.propagate},restore:function(){if(this.optimized){var a=this.optimized,b=function(){var b=Array.prototype.slice.call(arguments),c=b.shift(),d=b.pop(),e=d+"_";for(var f in b)e+=b[f]+"_";e+=c.ID;var g=a.memory,h=a.data.variables;return e in h?g[h[e].id]:0},c=this.neurons();for(var e in c){for(var f=c[e].neuron;f.neuron;)f=f.neuron;f.state=b(f,"state"),f.old=b(f,"old"),f.activation=b(f,"activation"),f.bias=b(f,"bias");for(var g in f.trace.elegibility)f.trace.elegibility[g]=b(f,"trace","elegibility",g);for(var h in f.trace.extended)for(var g in f.trace.extended[h])f.trace.extended[h][g]=b(f,"trace","extended",h,g)}for(var e in c){for(var f=c[e].neuron;f.neuron;)f=f.neuron;for(var i in f.connections.projected){var j=f.connections.projected[i];j.weight=b(j,"weight"),j.gain=b(j,"gain")}}}},neurons:function(){var a=[],b=this.layers.input.neurons(),c=this.layers.output.neurons();for(var d in b)a.push({neuron:b[d],layer:"input"});for(var e in this.layers.hidden){var f=this.layers.hidden[e].neurons();for(var d in f)a.push({neuron:f[d],layer:e})}for(var d in c)a.push({neuron:c[d],layer:"output"});return a},inputs:function(){return this.layers.input.size},outputs:function(){return this.layers.output.size},set:function(a){this.layers=a,this.optimized&&this.optimized.reset()},setOptimize:function(a){this.restore(),this.optimized&&this.optimized.reset(),this.optimized=!!a&&null},mutate:function(a){switch(a=a||Mutate.MODIFY_RANDOM_WEIGHT){case Mutate.SWAP_WEIGHT:for(var b=Math.floor(Math.random()*this.neurons().length),b=this.neurons()[b].neuron,c=Math.floor(Math.random()*this.neurons().length),c=this.neurons()[c].neuron,d=["gated","inputs","projected"],e=["gated","inputs","projected"],f=2;f>=0;f--)0==Object.keys(b.connections[d[f]]).length&&d.splice(f,1),0==Object.keys(c.connections[e[f]]).length&&e.splice(f,1);d=d[Math.floor(Math.random()*d.length)];var g=Object.keys(b.connections[d]),h=g[Math.floor(Math.random()*g.length)];e=e[Math.floor(Math.random()*e.length)];var i=Object.keys(c.connections[e]),j=i[Math.floor(Math.random()*i.length)],k=b.connections[d][h].weight;b.connections[d][h].weight=c.connections[e][j].weight,c.connections[e][j].weight=k;break;case Mutate.SWAP_BIAS:var b=Math.floor(Math.random()*this.neurons().length),b=this.neurons()[b].neuron,c=Math.floor(Math.random()*this.neurons().length),c=this.neurons()[c].neuron,k=b.bias;b.bias=c.bias,c.bias=k;break;case Mutate.MODIFY_RANDOM_BIAS:var l=Math.floor(Math.random()*this.neurons().length);this.neurons()[l].neuron.bias+=2*(Math.random()-.5);break;case Mutate.MODIFY_RANDOM_WEIGHT:for(var l=Math.floor(Math.random()*this.neurons().length),l=this.neurons()[l].neuron,m=["gated","inputs","projected"],f=m.length-1;f>=0;f--)0==Object.keys(l.connections[m[f]]).length&&m.splice(f,1);m=m[Math.floor(Math.random()*m.length)];var n=Object.keys(l.connections[m]),o=n[Math.floor(Math.random()*n.length)];l.connections[m][o].weight+=2*(Math.random()-.5)}},toJSON:function(a){this.restore();var b=this.neurons(),c=[],d=[],e={};for(var f in b){for(var g=b[f].neuron;g.neuron;)g=g.neuron;e[g.ID]=f;var h={trace:{elegibility:{},extended:{}},state:g.state,old:g.old,activation:g.activation,bias:g.bias,layer:b[f].layer};h.squash=g.squash==Neuron.squash.LOGISTIC?"LOGISTIC":g.squash==Neuron.squash.TANH?"TANH":g.squash==Neuron.squash.IDENTITY?"IDENTITY":g.squash==Neuron.squash.HLIM?"HLIM":null,c.push(h)}for(var f in b){for(var g=b[f].neuron;g.neuron;)g=g.neuron;for(var i in g.connections.projected){var j=g.connections.projected[i];d.push({from:e[j.from.ID],to:e[j.to.ID],weight:j.weight,gater:j.gater?e[j.gater.ID]:null})}g.selfconnected()&&d.push({from:e[g.ID],to:e[g.ID],weight:g.selfconnection.weight,gater:g.selfconnection.gater?e[g.selfconnection.gater.ID]:null})}return{neurons:c,connections:d}},toDot:function(a){var b="digraph nn {\n    rankdir = BT\n",c=[this.layers.input].concat(this.layers.hidden,this.layers.output);for(var d in c)for(var e in c[d].connectedTo){var f=c[d].connectedTo[e],g=f.to,h=f.size,i=c.indexOf(c[d]),j=c.indexOf(g);if(a){if(f.gatedfrom.length){var k="fake"+i+"_"+j;b+="    "+k+' [label = "", shape = point, width = 0.01, height = 0.01]\n',b+="    "+i+" -> "+k+" [label = "+h+", arrowhead = none]\n",b+="    "+k+" -> "+j+"\n"}else b+="    "+i+" -> "+j+" [label = "+h+"]\n";for(var l in f.gatedfrom){var m=f.gatedfrom[l].layer,n=c.indexOf(m);b+="    "+n+" -> "+k+" [color = blue]\n"}}else{b+="    "+i+" -> "+j+" [label = "+h+"]\n";for(var l in f.gatedfrom){var m=f.gatedfrom[l].layer,n=c.indexOf(m);b+="    "+n+" -> "+j+" [color = blue]\n"}}}return b+="}\n",{code:b,link:"https://chart.googleapis.com/chart?chl="+escape(b.replace("/ /g","+"))+"&cht=gv"}},standalone:function(){this.optimized||this.optimize();var a=this.optimized.data,b="function (input) {\n";for(var c in a.inputs)b+="F["+a.inputs[c]+"] = input["+c+"];\n";for(var d in a.activate)for(var e in a.activate[d])b+=a.activate[d][e].join("")+"\n";b+="var output = [];\n";for(var c in a.outputs)b+="output["+c+"] = F["+a.outputs[c]+"];\n";b+="return output;\n}";var f=b.match(/F\[(\d+)\]/g),g=0,h={};for(var i in f){var j=f[i].match(/\d+/)[0];j in h||(h[j]=g++)}var k="F = {\n";for(var c in h)k+=h[c]+": "+this.optimized.memory[c]+",\n";return k=k.substring(0,k.length-2)+"\n};\n",k="var run = "+b.replace(/F\[(\d+)]/g,function(a){return"F["+h[a.match(/\d+/)[0]]+"]"}).replace("{\n","{\n"+k)+";\n",k+="return run",new Function(k)()},worker:function(a,b,c){var d={};c&&(d=c),d.rate=c.rate||.2,d.iterations=c.iterations||1e5,d.error=c.error||.005,d.cost=c.cost||null,d.crossValidate=c.crossValidate||null,costFunction="var cost = "+(c&&c.cost||this.cost||Trainer.cost.MSE)+";\n";var e=Network.getWorkerSharedFunctions();e=e.replace(/var cost = options && options\.cost \|\| this\.cost \|\| Trainer\.cost\.MSE;/g,costFunction),e=e.replace("return results;",'postMessage({action: "done", message: results, memoryBuffer: F}, [F.buffer]);'),e=e.replace("console.log('iterations', iterations, 'error', error, 'rate', currentRate)","postMessage({action: 'log', message: {\niterations: iterations,\nerror: error,\nrate: currentRate\n}\n})"),e=e.replace("abort = this.schedule.do({ error: error, iterations: iterations, rate: currentRate })","postMessage({action: 'schedule', message: {\niterations: iterations,\nerror: error,\nrate: currentRate\n}\n})"),this.optimized||this.optimize();var f="var inputs = "+this.optimized.data.inputs.length+";\n";f+="var outputs = "+this.optimized.data.outputs.length+";\n",f+="var F =  new Float64Array(["+this.optimized.memory.toString()+"]);\n",f+="var activate = "+this.optimized.activate.toString()+";\n",f+="var propagate = "+this.optimized.propagate.toString()+";\n",f+="onmessage = function(e) {\nif (e.data.action == 'startTraining') {\ntrain("+JSON.stringify(b)+","+JSON.stringify(d)+");\n}\n}";var g=e+"\n"+f,h=new Blob([g]),i=window.URL.createObjectURL(h);return new Worker(i)},clone:function(){return Network.fromJSON(this.toJSON())}},Network.getWorkerSharedFunctions=function(){if("undefined"!=typeof Network._SHARED_WORKER_FUNCTIONS)return Network._SHARED_WORKER_FUNCTIONS;var a=Trainer.prototype.train.toString();a=a.replace("function (set","function train(set")+"\n";var b=Trainer.prototype._trainSet.toString().replace(/this.network./g,"");b=b.replace("function (set","function _trainSet(set")+"\n",b=b.replace("this.crossValidate","crossValidate"),b=b.replace("crossValidate = true","crossValidate = { }");var c=Trainer.prototype.test.toString().replace(/this.network./g,"");return c=c.replace("function (set","function test(set")+"\n",Network._SHARED_WORKER_FUNCTIONS=a+b+c},Network.fromJSON=function(a){var b=[],c={input:new Layer,hidden:[],output:new Layer};for(var d in a.neurons){var e=a.neurons[d],f=new Neuron;f.trace.elegibility={},f.trace.extended={},f.state=e.state,f.old=e.old,f.activation=e.activation,f.bias=e.bias,f.squash=e.squash in Neuron.squash?Neuron.squash[e.squash]:Neuron.squash.LOGISTIC,b.push(f),"input"==e.layer?c.input.add(f):"output"==e.layer?c.output.add(f):("undefined"==typeof c.hidden[e.layer]&&(c.hidden[e.layer]=new Layer),c.hidden[e.layer].add(f))}for(var d in a.connections){var e=a.connections[d],g=b[e.from],h=b[e.to],i=e.weight,j=b[e.gater],k=g.project(h,i);j&&j.gate(k)}return new Network(c)},Network.crossOver=function(a,b,c){c=c||Crossover.UNIFORM;var a=a.toJSON(),b=b.toJSON(),d=Network.fromJSON(a).toJSON();switch(c){case Crossover.UNIFORM:for(var e=0;e<d.neurons.length;e++)Math.random()>=.5?d.neurons[e].bias=a.neurons[e].bias:d.neurons[e].bias=b.neurons[e].bias;for(var e=0;e<d.connections.length;e++)Math.random()>=.5?d.connections[e].weight=a.connections[e].weight:d.connections[e].weight=b.connections[e].weight;break;case Crossover.AVERAGE:for(var e=0;e<d.neurons.length;e++){var f=a.neurons[e].bias,g=b.neurons[e].bias;d.neurons[e].bias=(f+g)/2}for(var e=0;e<d.connections.length;e++){
var h=a.connections[e].weight,i=b.connections[e].weight;d.connections[e].weight=(h+i)/2}break;case Crossover.SINGLE_POINT:for(var e=0;e<d.neurons.length;e++)e/d.neurons.length<Crossover.SINGLE_POINT[0]?d.neurons[e].bias=a.neurons[e].bias:d.neurons[e].bias=b.neurons[e].bias;for(var e=0;e<d.connections.length;e++)e/d.connections.length<Crossover.SINGLE_POINT[0]?d.connections[e].weight=a.connections[e].weight:d.connections[e].weight=b.connections[e].weight;break;case Crossover.TWO_POINT:for(var e=0;e<d.neurons.length;e++)e/d.neurons.length<Crossover.SINGLE_POINT[0]||e/d.neurons.length>Crossover.SINGLE_POINT[1]?d.neurons[e].bias=a.neurons[e].bias:d.neurons[e].bias=b.neurons[e].bias;for(var e=0;e<d.connections.length;e++)e/d.connections.length<Crossover.SINGLE_POINT[0]||e/d.connections.length>Crossover.SINGLE_POINT[1]?d.connections[e].weight=a.connections[e].weight:d.connections[e].weight=b.connections[e].weight}return Network.fromJSON(d)};var Architect={Perceptron:function(){var b=Array.prototype.slice.call(arguments);if(b.length<3)throw new Error("not enough layers (minimum 3) !!");var c=b.shift(),d=b.pop(),e=b,f=new Layer(c),g=[],h=new Layer(d),i=f;for(var j in e){var k=e[j],l=new Layer(k);g.push(l),i.project(l),i=l}i.project(h),this.set({input:f,hidden:g,output:h}),this.trainer=new Trainer(this)},LSTM:function(){var b=Array.prototype.slice.call(arguments);if(b.length<3)throw new Error("not enough layers (minimum 3) !!");var c=b.pop(),d={peepholes:Layer.connectionType.ALL_TO_ALL,hiddenToHidden:!1,outputToHidden:!1,outputToGates:!1,inputToOutput:!0};if("number"!=typeof c){var e=b.pop();c.hasOwnProperty("peepholes")&&(d.peepholes=c.peepholes),c.hasOwnProperty("hiddenToHidden")&&(d.hiddenToHidden=c.hiddenToHidden),c.hasOwnProperty("outputToHidden")&&(d.outputToHidden=c.outputToHidden),c.hasOwnProperty("outputToGates")&&(d.outputToGates=c.outputToGates),c.hasOwnProperty("inputToOutput")&&(d.inputToOutput=c.inputToOutput)}else var e=c;var f=b.shift(),g=b,h=new Layer(f),i=[],j=new Layer(e),k=null;for(var l in g){var m=g[l],n=new Layer(m).set({bias:1}),o=new Layer(m).set({bias:1}),p=new Layer(m),q=new Layer(m).set({bias:1});i.push(n),i.push(o),i.push(p),i.push(q);var r=h.project(p);if(h.project(n),h.project(o),h.project(q),null!=k){var s=k.project(p);k.project(n),k.project(o),k.project(q)}var t=p.project(j),u=p.project(p);d.hiddenToHidden&&p.project(p,Layer.connectionType.ALL_TO_ELSE),d.outputToHidden&&j.project(p),d.outputToGates&&(j.project(n),j.project(q),j.project(o)),p.project(n,d.peepholes),p.project(o,d.peepholes),p.project(q,d.peepholes),n.gate(r,Layer.gateType.INPUT),o.gate(u,Layer.gateType.ONE_TO_ONE),q.gate(t,Layer.gateType.OUTPUT),null!=k&&n.gate(s,Layer.gateType.INPUT),k=p}d.inputToOutput&&h.project(j),this.set({input:h,hidden:i,output:j}),this.trainer=new Trainer(this)},Liquid:function(b,c,d,e,f){for(var g=new Layer(b),h=new Layer(c),i=new Layer(d),j=h.neurons(),k=[],l=0;l<e;l++){var m=Math.random()*j.length|0,n=Math.random()*j.length|0,o=j[m].project(j[n]);k.push(o)}for(var p=0;p<f;p++){var q=Math.random()*j.length|0,o=Math.random()*k.length|0;j[q].gate(k[o])}g.project(h),h.project(i),this.set({input:g,hidden:[h],output:i}),this.trainer=new Trainer(this)},Hopfield:function(b){var c=new Layer(b),d=new Layer(b);c.project(d,Layer.connectionType.ALL_TO_ALL),this.set({input:c,hidden:[],output:d});var e=new Trainer(this),f=Architect.Hopfield.prototype;f.learn=f.learn||function(a){var b=[];for(var c in a)b.push({input:a[c],output:a[c]});return e.train(b,{iterations:5e5,error:5e-5,rate:1})},f.feed=f.feed||function(a){var b=this.activate(a),a=[];for(var c in b)a[c]=b[c]>.5?1:0;return a}}};for(var architecture in Architect)Architect[architecture].prototype=new Network,Architect[architecture].prototype.constructor=Architect[architecture];Trainer.prototype={train:function(a,b){function l(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}var f,i,j,c=1,d=m=0,e=!1,g=b&&b.cost||this.cost||Trainer.cost.MSE,h=!1,k=Date.now();if(b&&(b.shuffle,b.iterations&&(this.iterations=b.iterations),b.error&&(this.error=b.error),b.rate&&(this.rate=b.rate),b.cost&&(this.cost=b.cost),b.schedule&&(this.schedule=b.schedule),b.customLog&&(console.log("Deprecated: use schedule instead of customLog"),this.schedule=b.customLog),(this.crossValidate||b.crossValidate)&&(this.crossValidate||(this.crossValidate={}),h=!0,b.crossValidate.testSize&&(this.crossValidate.testSize=b.crossValidate.testSize),b.crossValidate.testError&&(this.crossValidate.testError=b.crossValidate.testError))),f=this.rate,Array.isArray(this.rate))var m=Math.floor(this.iterations/this.rate.length);if(h){var n=Math.ceil((1-this.crossValidate.testSize)*a.length);j=a.slice(0,n),i=a.slice(n)}for(var o=0;!e&&d<this.iterations&&c>this.error&&!(h&&c<=this.crossValidate.testError);){var p=a.length;if(c=0,d++,m>0){var q=Math.floor(d/m);f=this.rate[q]||f}"function"==typeof this.rate&&(f=this.rate(d,o)),h?(this._trainSet(j,f,g),c+=this.test(i).error,p=1):(c+=this._trainSet(a,f,g),p=a.length),c/=p,o=c,b&&(this.schedule&&this.schedule.every&&d%this.schedule.every==0?e=this.schedule.do({error:c,iterations:d,rate:f}):b.log&&d%b.log==0&&console.log("iterations",d,"error",c,"rate",f),b.shuffle&&l(a))}var r={error:c,iterations:d,time:Date.now()-k};return r},trainAsync:function(a,b){var c=this.workerTrain.bind(this);return new Promise(function(d,e){try{c(a,d,b,!0)}catch(a){e(a)}})},_trainSet:function(a,b,c){var d=0;for(var e in a){var f=a[e].input,g=a[e].output,h=this.network.activate(f);this.network.propagate(b,g),d+=c(g,h)}return d},test:function(a,b){var d,e,f,c=0,g=b&&b.cost||this.cost||Trainer.cost.MSE,h=Date.now();for(var i in a)d=a[i].input,f=a[i].output,e=this.network.activate(d),c+=g(f,e);c/=a.length;var j={error:c,time:Date.now()-h};return j},workerTrain:function(a,b,c,d){d||console.warn("Deprecated: do not use `workerTrain`, use `trainAsync` instead.");var e=this;this.network.optimized||this.network.optimize();var f=this.network.worker(this.network.optimized.memory,a,c);f.onmessage=function(a){switch(a.data.action){case"done":var d=a.data.message.iterations,g=a.data.message.error,h=a.data.message.time;e.network.optimized.ownership(a.data.memoryBuffer),b({error:g,iterations:d,time:h}),f.terminate();break;case"log":console.log(a.data.message);case"schedule":if(c&&c.schedule&&"function"==typeof c.schedule.do){var i=c.schedule.do;i(a.data.message)}}},f.postMessage({action:"startTraining"})},XOR:function(a){if(2!=this.network.inputs()||1!=this.network.outputs())throw new Error("Incompatible network (2 inputs, 1 output)");var b={iterations:1e5,log:!1,shuffle:!0,cost:Trainer.cost.MSE};if(a)for(var c in a)b[c]=a[c];return this.train([{input:[0,0],output:[0]},{input:[1,0],output:[1]},{input:[0,1],output:[1]},{input:[1,1],output:[0]}],b)},DSR:function(a){a=a||{};var l,m,n,o,p,b=a.targets||[2,4,7,8],c=a.distractors||[3,5,6,9],d=a.prompts||[0,1],e=a.length||24,f=a.success||.95,g=a.iterations||1e5,h=a.rate||.1,i=a.log||0,j=a.schedule||{},k=a.cost||this.cost||Trainer.cost.CROSS_ENTROPY;l=m=n=o=p=0;for(var q=1,r=b.length+c.length+d.length,s=function(a,b){var c=Math.random()*a|0,d=!1;for(var e in b)c==b[e]&&(d=!0);return d?s(a,b):c},t=function(a,b){for(var c in a)if(Math.round(a[c])!=b[c])return!1;return!0},u=Date.now();l<g&&(p<f||l%1e3!=0);){var v=[],w=e-d.length;for(n=0;n<w;n++){var x=Math.random()*c.length|0;v.push(c[x])}var y=[],z=[];for(n=0;n<d.length;n++)y.push(Math.random()*b.length|0),z.push(s(w,z));for(z=z.sort(),n=0;n<d.length;n++)v[z[n]]=b[y[n]],v.push(d[n]);var A,B=A=0;for(q=0,n=0;n<e;n++){var C=[];for(o=0;o<r;o++)C[o]=0;C[v[n]]=1;var D=[];for(o=0;o<b.length;o++)D[o]=0;if(n>=w){var E=n-w;D[y[E]]=1}var F=this.network.activate(C);t(F,D)?n<w?A++:B++:this.network.propagate(h,D),q+=k(D,F),A+B==e&&m++}l%1e3==0&&(m=0),l++;var G=l%1e3;G=0==G?1e3:G,p=m/G,q/=e,i&&l%i==0&&console.log("iterations:",l," success:",p," correct:",m," time:",Date.now()-u," error:",q),j.do&&j.every&&l%j.every==0&&j.do({iterations:l,success:p,error:q,time:Date.now()-u,correct:m})}return{iterations:l,success:p,error:q,time:Date.now()-u}},ERG:function(a){a=a||{};var b=a.iterations||15e4,c=a.error||.05,d=a.rate||.1,e=a.log||500,f=a.cost||this.cost||Trainer.cost.CROSS_ENTROPY,g=function(){this.paths=[]};g.prototype={connect:function(a,b){return this.paths.push({node:a,value:b}),this},any:function(){if(0==this.paths.length)return!1;var a=Math.random()*this.paths.length|0;return this.paths[a]},test:function(a){for(var b in this.paths)if(this.paths[b].value==a)return this.paths[b];return!1}};for(var h=function(){var a=new g,b=(new g).connect(a,"E"),c=(new g).connect(b,"S"),d=(new g).connect(b,"V").connect(c,"P"),e=(new g).connect(c,"X");e.connect(e,"S");var f=(new g).connect(d,"V");f.connect(f,"T"),c.connect(f,"X");var h=(new g).connect(e,"T").connect(f,"P"),i=(new g).connect(h,"B");return{input:i,output:a}},i=function(){var a=h(),b=h(),c=new g,d=(new g).connect(c,"E");a.output.connect(d,"T"),b.output.connect(d,"P");var e=(new g).connect(a.input,"P").connect(b.input,"T"),f=(new g).connect(e,"B");return{input:f,output:c}},j=function(){for(var a=i().input,b=a.any(),c="";b;)c+=b.value,b=b.node.any();return c},k=function(a){for(var b=i().input,c=0,d=a.charAt(c);c<a.length;){var e=b.test(d);if(!e)return!1;b=e.node,d=a.charAt(++c)}return!0},l=function(a,b){var c=0,d=-1,e=0,f=-1;for(var g in a)a[g]>c&&(c=a[g],d=g),b[g]>e&&(e=b[g],f=g);return d!=f},m=0,n=1,o={B:0,P:1,T:2,X:3,S:4,E:5},p=Date.now();m<b&&n>c;){var q=0;n=0;for(var r=j(),s=r.charAt(q),t=r.charAt(q+1);q<r.length-1;){for(var u=[],v=[],w=0;w<6;w++)u[w]=0,v[w]=0;u[o[s]]=1,v[o[t]]=1;var x=this.network.activate(u);l(x,v)&&this.network.propagate(d,v),s=r.charAt(++q),t=r.charAt(q+1),n+=f(v,x)}n/=r.length,m++,m%e==0&&console.log("iterations:",m," time:",Date.now()-p," error:",n)}return{iterations:m,error:n,time:Date.now()-p,test:k,generate:j}},timingTask:function(a){function b(a,b){for(var c=a+b,d=0,e=[],f=0;f<c;f++)e.push({input:[0,0],output:[0]});for(;d<c-20;){var g=Math.round(20*Math.random());e[d].input[0]=1;for(var h=d;h<=d+g;h++)e[h].input[1]=g/20,e[h].output[0]=.5;d+=g,g=Math.round(20*Math.random());for(var i=d+1;i<=d+g&&i<c;i++)e[i].input[1]=e[d].input[1];d+=g}for(var j=[],k=[],l=0;l<c;l++)(l<a?j:k).push(e[l]);return{train:j,test:k}}if(2!=this.network.inputs()||1!=this.network.outputs())throw new Error("Invalid Network: must have 2 inputs and one output");"undefined"==typeof a&&(a={});var c=a.iterations||200,d=a.error||.005,e=a.rate||[.03,.02],f=a.log!==!1&&(a.log||10),g=a.cost||this.cost||Trainer.cost.MSE,h=a.trainSamples||7e3,i=a.trainSamples||1e3,j=b(h,i),k=this.train(j.train,{rate:e,log:f,iterations:c,error:d,cost:g});return{train:k,test:this.test(j.test)}}},Trainer.cost={CROSS_ENTROPY:function(a,b){var c=0;for(var d in b)c-=a[d]*Math.log(b[d]+1e-15)+(1-a[d])*Math.log(1+1e-15-b[d]);return c},MSE:function(a,b){var c=0;for(var d in b)c+=Math.pow(a[d]-b[d],2);return c/b.length},BINARY:function(a,b){var c=0;for(var d in b)c+=Math.round(2*a[d])!=Math.round(2*b[d]);return c}},Mutate={},Mutate.SWAP_WEIGHT="SWAP_WEIGHT",Mutate.SWAP_BIAS="SWAP_BIAS",Mutate.MODIFY_RANDOM_WEIGHT="MODIFY_RANDOM_WEIGHT",Mutate.MODIFY_RANDOM_BIAS="MODIFY_RANDOM_BIAS",Crossover={},Crossover.SINGLE_POINT=[.4],Crossover.TWO_POINT=[.4,.9],Crossover.UNIFORM="UNIFORM",Crossover.AVERAGE="AVERAGE",Selection={},Selection.FITNESS_PROPORTIONATE=function(a){return Math.pow(a,2)},Evolution.prototype={createPool:function(){for(var a=0;a<this.size;a++){for(var b=new Layer(this.networkSize[0]),c=new Layer(this.networkSize[this.networkSize.length-1]),d=[],e=0;e<this.networkSize.length-2;e++)d.push(new Layer(this.networkSize[e+1])),e>0&&d[e-1].project(d[e]);b.project(d[0]),d[d.length-1].project(c),this.population.push(new Network({input:b,hidden:d,output:c}))}},evaluate:function(){for(var a in this.population){var b=this.fitnessFunction(this.population[a]);this.scores.push(b)}},select:function(){var a=this.getSortedIndex();if(this.elitism>0)for(var b=0;b<this.elitism;b++)this.newPopulation.push(this.population[a[b]]);for(var b=0;b<this.size-this.elitism;b++){var c=this.getParent(a);this.parentSelection.push(c);var c=this.getParent(a);this.parentSelection.push(c)}},crossOver:function(){for(var a=0;a<this.parentSelection.length;a+=2){var b=this.crossOverMethod[Math.floor(Math.random()*this.crossOverMethod.length)],c=Network.crossOver(this.parentSelection[a],this.parentSelection[a+1],b);this.newPopulation.push(c)}},mutate:function(){for(var a=0;a<this.newPopulation.length;a++)if(Math.random()<this.mutationRate){var b=this.mutationMethod[Math.floor(Math.random()*this.mutationMethod.length)];this.newPopulation[a].mutate(b)}},replace:function(){this.population=[];for(var a=0;a<this.newPopulation.length;a++)this.population.push(this.newPopulation[a]);this.newPopulation=[],this.parentSelection=[],this.scores=[]},getParent:function(a){switch(this.selectionMethod[0]){case Selection.FITNESS_PROPORTIONATE:var b=Math.floor(Selection.FITNESS_PROPORTIONATE(Math.random())*this.size);return this.population[a[b]]}},getSortedIndex:function(){for(var a=this.scores.slice(),b=[],c=0;c<a.length;c++){var d=a.indexOf(Math.max.apply(Math,a));a[d]=-1,b.push(d)}return b},getAverage:function(){var a=this.scores.reduce(function(a,b){return a+b});return a/this.scores.length}};